
<!doctype html>
<html>

<head>
	<title>How Tax Brackets Work</title>
	<script src="https://www.chartjs.org/dist/2.9.4/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <script src="https://unpkg.com/vue"></script>
	<style>
	canvas {
		-moz-user-select: none;
		-webkit-user-select: none;
		-ms-user-select: none;
	}
	</style>
</head>

<body>
	<div style="width:80%;">
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
    <button id="rebuildGraph">Rebuild Graph</button>
    <button id="addNewTaxBracket">Add New Tax Bracket</button>
    <button id="removeTaxBracket">Remove Selected Tax Bracket</button>
    <br />
    <div id="app">
        For incomes between <input id="min" v-model="min" /> and <input id="max" v-model="max" /> going up by <input id="step" v-model="step" />
        <br />
        <ul>
            <li v-for="(bracket, index) in taxBrackets">
                <input type="radio" v-model="selectedRow" :value="`${index}`" :id="`bracket-row-${index}`" />Incomes up to <input :id="`bracket-max-${index}`" v-model="bracket.bracketMax" /> are taxed at a rate of <input :id="`bracket-taxRate-{index}`" v-model="bracket.taxRate" />
            </li>
        </ul>
    </div>
	<script>
        var app;
        var defaultMin = 10000;
        var defaultMax = 500000;
        var defaultStep = 10000;
        var defaultTaxBrackets = [{
                taxRate: .10,
                bracketMax: 15000
            },
            {
                taxRate: .15,
                bracketMax: 50000
            },
            {
                taxRate: .25,
                bracketMax: 200000
            },
            {
                taxRate: .30,
                bracketMax: 300000
            },
            {
                taxRate: .40,
                bracketMax: Number.MAX_SAFE_INTEGER
            }];
        var defaultSelectedRow = 0;
        var colorNames = Object.keys(window.chartColors);
		var config = {
			type: 'line',
			data: {
				labels: [],
				datasets: [{
					label: 'Tax Amount per Income',
					backgroundColor: window.chartColors.red,
					borderColor: window.chartColors.red,
					data: [
					],
					fill: false,
				}]
			},
			options: {
				responsive: true,
				title: {
					display: true,
					text: 'Income'
				},
				tooltips: {
					mode: 'index',
					intersect: false,
				},
				hover: {
					mode: 'nearest',
					intersect: true
				},
				scales: {
					xAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Income'
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Tax Amount'
						}
					}]
				}
			}
		};

		window.onload = function() {
			var ctx = document.getElementById('canvas').getContext('2d');
            app = new Vue({
                el: '#app',
                data : {
                    min: defaultMin,
                    max: defaultMax,
                    taxBrackets: defaultTaxBrackets,
                    step: defaultStep,
                    selectedRow: defaultSelectedRow
                }
            });            
            buildChart();
			window.myLine = new Chart(ctx, config);            
		};

        function buildChart(){
            config.data.datasets[0].data = [];
            config.data.labels = [];
            var i = app.min;
            while(i <= app.max){
                config.data.labels.push(i);
                var taxAmount = getTaxAmount(i);
                config.data.datasets[0].data.push(taxAmount);
                i = parseInt(i) + parseInt(app.step);
            }
        }

        function getTaxAmount(income){
            var taxAmount = 0;
            var previousMax = 0;
            app.taxBrackets.forEach(function(item, index){
                if(income > item.bracketMax){
                    taxAmount += (item.bracketMax - previousMax) * item.taxRate;
                }
                else if(income > previousMax){
                    taxAmount += (income - previousMax) * item.taxRate;
                }
                previousMax = item.bracketMax;
            });
            return taxAmount;
        }

		document.getElementById('rebuildGraph').addEventListener('click', function() {
			buildChart();
            window.myLine.update();
		});

        document.getElementById('addNewTaxBracket').addEventListener('click', function(){
            var secondHighestIncome = app.taxBrackets[app.taxBrackets.length - 2].bracketMax;
            var highestTaxRate = app.taxBrackets[app.taxBrackets.length - 1].taxRate;
            app.taxBrackets[app.taxBrackets.length - 1].bracketMax = parseInt(secondHighestIncome) + 1;
            app.taxBrackets.push({
                taxRate: (highestTaxRate + .01).toFixed(2),
                bracketMax: Number.MAX_SAFE_INTEGER
            });
        });

        document.getElementById('removeTaxBracket').addEventListener('click', function(){
            var selRow = app.selectedRow;
            if(app.taxBrackets.length == parseInt(selRow) + 1 && app.taxBrackets.length > 1){
                app.taxBrackets[selRow - 1].bracketMax = Number.MAX_SAFE_INTEGER;
            }
            app.taxBrackets.splice(selRow, 1);
        });
	</script>
</body>

</html>